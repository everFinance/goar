package utils

import (
	"encoding/json"
	"github.com/go-webauthn/webauthn/webauthn"
	"github.com/stretchr/testify/assert"
	"testing"
)

func TestVerifyFidoAuthnSig(t *testing.T) {

	// 从 URL 解析参数  https://api-dev.everpay.io/fido/auth_verify?sig=eyJpZCI6IldjcUlNbExzcTdpamxDZzJaeWozYzdHM0cwRXctSEkwcU4tTHM4emF5OEkiLCJyYXdJZCI6IldjcUlNbExzcTdpamxDZzJaeWozYzdHM0cwRXctSEkwcU4tTHM4emF5OEkiLCJjbGllbnREYXRhSlNPTiI6ImV5SjBlWEJsSWpvaWQyVmlZWFYwYUc0dVoyVjBJaXdpWTJoaGJHeGxibWRsSWpvaVRVaG5NbGxVUlRWTmFrcG9XbGRHYkZwRVdURlpiVTB3VDFSRk1WcFVSbTFOUjFGNldXcFdiRTFFV1ROTmFsWnRXVlJGTkZwWFRtaGFSR015VG0xT2JWa3lWVEpPVkVFeFRsUkpNRnB0VW10TlZHTjVUbnBOTXlJc0ltOXlhV2RwYmlJNkltaDBkSEE2THk5c2IyTmhiR2h2YzNRNk9EQTRNQ0lzSW1OeWIzTnpUM0pwWjJsdUlqcG1ZV3h6WlgwIiwiYXV0aGVudGljYXRvckRhdGEiOiJTWllONVlnT2pHaDBOQmNQWkhaZ1c0X2tycm1paGpMSG1Wenp1b01kbDJNRkFBQUFBQSIsInNpZ25hdHVyZSI6Ik1FUUNJSFkwUTFSWTMyc0ZINTN1c191bW9GVHRzVUNmVUIzZ09zbkdqc0NEdjRibUFpQnRPOXBOdmpDb2t3NGRlTjRVREljSFNFT2lJVjhXT2kxUWFtallkamI3QWciLCJ1c2VySGFuZGxlIjoiTVNCZlN5enpPYjZpQVEifQ==&eid=eid55b70c27f543a3864a70c6b45c8ce928e6e350c08569e143a1c305c834828c081e13&hash=0x6a1922aeaed65bc4915e1f0d3b5e06725fa18ecad766cfce6505524fdd172737&public=eyJJRCI6IldjcUlNbExzcTdpamxDZzJaeWozYzdHM0cwRXcrSEkwcU4rTHM4emF5OEk9IiwiUHVibGljS2V5IjoicFFFQ0F5WWdBU0ZZSUZiNnR6NUVkTUtJNzlMRmxMY1NrSjdBWnRQTjlCOXU3OFJFU291U1NrQXFJbGdnRjEyQTlmK3M2M3NCVmlYeVYra0JlZ0pVSW5YSnVic0YxSk9JUGwxZkl6UT0iLCJBdHRlc3RhdGlvblR5cGUiOiJwYWNrZWQiLCJUcmFuc3BvcnQiOlsiaW50ZXJuYWwiXSwiRmxhZ3MiOnsiVXNlclByZXNlbnQiOnRydWUsIlVzZXJWZXJpZmllZCI6dHJ1ZSwiQmFja3VwRWxpZ2libGUiOmZhbHNlLCJCYWNrdXBTdGF0ZSI6ZmFsc2V9LCJBdXRoZW50aWNhdG9yIjp7IkFBR1VJRCI6InJjNEFBalc4eGdwa2l3c2w4ZkJWQXc9PSIsIlNpZ25Db3VudCI6MCwiQ2xvbmVXYXJuaW5nIjpmYWxzZSwiQXR0YWNobWVudCI6InBsYXRmb3JtIn19
	sig := "eyJpZCI6IldjcUlNbExzcTdpamxDZzJaeWozYzdHM0cwRXctSEkwcU4tTHM4emF5OEkiLCJyYXdJZCI6IldjcUlNbExzcTdpamxDZzJaeWozYzdHM0cwRXctSEkwcU4tTHM4emF5OEkiLCJjbGllbnREYXRhSlNPTiI6ImV5SjBlWEJsSWpvaWQyVmlZWFYwYUc0dVoyVjBJaXdpWTJoaGJHeGxibWRsSWpvaVRVaG5NbGxVUlRWTmFrcG9XbGRHYkZwRVdURlpiVTB3VDFSRk1WcFVSbTFOUjFGNldXcFdiRTFFV1ROTmFsWnRXVlJGTkZwWFRtaGFSR015VG0xT2JWa3lWVEpPVkVFeFRsUkpNRnB0VW10TlZHTjVUbnBOTXlJc0ltOXlhV2RwYmlJNkltaDBkSEE2THk5c2IyTmhiR2h2YzNRNk9EQTRNQ0lzSW1OeWIzTnpUM0pwWjJsdUlqcG1ZV3h6WlgwIiwiYXV0aGVudGljYXRvckRhdGEiOiJTWllONVlnT2pHaDBOQmNQWkhaZ1c0X2tycm1paGpMSG1Wenp1b01kbDJNRkFBQUFBQSIsInNpZ25hdHVyZSI6Ik1FUUNJSFkwUTFSWTMyc0ZINTN1c191bW9GVHRzVUNmVUIzZ09zbkdqc0NEdjRibUFpQnRPOXBOdmpDb2t3NGRlTjRVREljSFNFT2lJVjhXT2kxUWFtallkamI3QWciLCJ1c2VySGFuZGxlIjoiTVNCZlN5enpPYjZpQVEifQ=="
	eid := "eid55b70c27f543a3864a70c6b45c8ce928e6e350c08569e143a1c305c834828c081e13"
	hexHash := "0x6a1922aeaed65bc4915e1f0d3b5e06725fa18ecad766cfce6505524fdd172737"
	public := "eyJJRCI6IldjcUlNbExzcTdpamxDZzJaeWozYzdHM0cwRXcrSEkwcU4rTHM4emF5OEk9IiwiUHVibGljS2V5IjoicFFFQ0F5WWdBU0ZZSUZiNnR6NUVkTUtJNzlMRmxMY1NrSjdBWnRQTjlCOXU3OFJFU291U1NrQXFJbGdnRjEyQTlmK3M2M3NCVmlYeVYra0JlZ0pVSW5YSnVic0YxSk9JUGwxZkl6UT0iLCJBdHRlc3RhdGlvblR5cGUiOiJwYWNrZWQiLCJUcmFuc3BvcnQiOlsiaW50ZXJuYWwiXSwiRmxhZ3MiOnsiVXNlclByZXNlbnQiOnRydWUsIlVzZXJWZXJpZmllZCI6dHJ1ZSwiQmFja3VwRWxpZ2libGUiOmZhbHNlLCJCYWNrdXBTdGF0ZSI6ZmFsc2V9LCJBdXRoZW50aWNhdG9yIjp7IkFBR1VJRCI6InJjNEFBalc4eGdwa2l3c2w4ZkJWQXc9PSIsIlNpZ25Db3VudCI6MCwiQ2xvbmVXYXJuaW5nIjpmYWxzZSwiQXR0YWNobWVudCI6InBsYXRmb3JtIn19"

	publicBy, err := Base64Decode(public)
	if err != nil {
		return
	}
	cred := webauthn.Credential{}
	if err = json.Unmarshal(publicBy, &cred); err != nil {
		return
	}
	_, err = VerifyFidoAuthnSig(sig, hexHash, eid, GenUserId(eid, 5), cred)

	assert.NoError(t, err)
	t.Log(err)

}
